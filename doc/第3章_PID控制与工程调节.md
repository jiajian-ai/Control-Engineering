# 第3章 PID控制与工程调节

> **课程大纲导航**: [返回课程大纲](../CONTROL_ENGINEERING_OUTLINE.md) | [上一章：系统动力学与响应](第2章_系统动力学与响应.md)

---

## 📚 本章概述

PID控制器是工业控制中应用最广泛的控制算法，占据了95%以上的工业过程控制应用。其成功的原因在于：**结构简单、参数直观、鲁棒性强、易于实现**。

**本章学习目标**：
1. 理解PID控制器的数学原理和物理意义
2. 掌握Kp、Ki、Kd三个参数的作用和调节方法
3. 学会使用经典整定方法（Ziegler-Nichols等）
4. 通过实验理解参数对系统性能的影响
5. 掌握实际工程中的PID调优技巧

**为什么学习PID控制？**
- 📌 工业控制的基石和首选方案
- 📌 理解反馈控制的核心思想
- 📌 为学习现代控制方法打下基础
- 📌 实用性强，可直接应用于实际项目

---

## 3.1 PID控制器的数学原理

### 3.1.1 PID控制器的结构

**闭环控制系统框图**：

```
        r(t)      e(t)        u(t)           y(t)
    设定值 ──→ ⊕ ───→ [PID控制器] ───→ [被控对象] ───→ 输出
              ↑ -                              │
              │                                │
              └────────────────────────────────┘
                        反馈
```

**信号定义**：
- $r(t)$：设定值（Setpoint / Reference）
- $y(t)$：实际输出（Process Variable）
- $e(t) = r(t) - y(t)$：误差（Error）
- $u(t)$：控制输出（Control Output）

### 3.1.2 PID控制器的数学表达式

**连续时间形式**：

$$u(t) = K_p e(t) + K_i \int_0^t e(\tau) d\tau + K_d \frac{de(t)}{dt}$$

或分项表示：

$$u(t) = u_p(t) + u_i(t) + u_d(t)$$

其中：

1. **比例项（Proportional）**：
   $$u_p(t) = K_p e(t)$$

2. **积分项（Integral）**：
   $$u_i(t) = K_i \int_0^t e(\tau) d\tau$$

3. **微分项（Derivative）**：
   $$u_d(t) = K_d \frac{de(t)}{dt}$$

**离散时间形式**（实际实现）：

$$u_k = K_p e_k + K_i \sum_{j=0}^k e_j \Delta t + K_d \frac{e_k - e_{k-1}}{\Delta t}$$

**传递函数形式**：

$$G_c(s) = \frac{U(s)}{E(s)} = K_p + \frac{K_i}{s} + K_d s$$

或标准形式：

$$G_c(s) = K_p \left(1 + \frac{1}{T_i s} + T_d s\right)$$

其中：
- $T_i = \frac{K_p}{K_i}$：积分时间常数
- $T_d = \frac{K_d}{K_p}$：微分时间常数

### 3.1.3 PID控制器的并联与串联形式

**并联形式（Independent）**：

$$u(t) = K_p e(t) + K_i \int e(\tau) d\tau + K_d \frac{de(t)}{dt}$$

- 三个参数独立调节
- 本项目采用此形式

**串联形式（Dependent）**：

$$u(t) = K_p \left[e(t) + \frac{1}{T_i} \int e(\tau) d\tau + T_d \frac{de(t)}{dt}\right]$$

- $K_p$ 影响所有项
- 工业仪表常用此形式

**两种形式的转换**：
- 并联 → 串联：$T_i = \frac{K_p}{K_i}$，$T_d = \frac{K_d}{K_p}$
- 串联 → 并联：$K_i = \frac{K_p}{T_i}$，$K_d = K_p T_d$

---

## 3.2 PID三要素的物理意义

### 3.2.1 比例控制（P - Proportional）

#### 数学表达

$$u_p(t) = K_p e(t)$$

**物理意义**：
- 控制作用**正比于**当前误差
- $K_p$：比例增益，放大系数

#### 作用机制

**类比**：开车时看到偏离车道→立即打方向盘

- **误差大** → 控制强
- **误差小** → 控制弱
- **误差为0** → 无控制

#### 响应曲线示意

```
    y(t)
     │
     │     ╱───── 有稳态误差 ess
  1.0│────╱
     │   ╱
     │  ╱
     │ ╱
     │╱
     └───────────────── t
        快速响应
```

#### Kp对系统的影响

| Kp增大 | 效果 |
|--------|------|
| ✅ 响应速度 | **加快** |
| ✅ 上升时间 | **减小** |
| ✅ 稳态误差 | **减小**（但不能完全消除） |
| ❌ 超调量 | **增大** |
| ❌ 振荡趋势 | **增强** |
| ⚠️ 稳定性 | Kp过大会导致不稳定 |

#### P控制的局限性

**稳态误差问题**：

对于0型系统，纯P控制存在稳态误差：

$$e_{ss} = \frac{r}{1 + K_p K}$$

- $K_p$ 越大，误差越小，但**无法完全消除**
- 需要引入积分项才能消除

**实际例子**：
- 温度控制：设定25°C，最终稳定在24.5°C
- 速度控制：设定100 km/h，最终稳定在98 km/h

### 3.2.2 积分控制（I - Integral）

#### 数学表达

$$u_i(t) = K_i \int_0^t e(\tau) d\tau$$

**物理意义**：
- 控制作用正比于误差的**累积**
- $K_i$：积分增益，累积速度

#### 作用机制

**类比**：银行存款利息→时间越长，累积越多

- **长期存在小误差** → 积分项持续累积
- **误差为0** → 积分项保持当前值
- **误差反向** → 积分项开始减小

#### 积分作用示意

```
积分项
  ↑
  │         ╱────── 稳态后保持
  │       ╱
  │     ╱
  │   ╱
  │ ╱
  └────────────────── t
     误差累积
```

#### Ki对系统的影响

| Ki增大 | 效果 |
|--------|------|
| ✅ 稳态误差 | **消除** |
| ✅ 抗干扰能力 | **增强** |
| ❌ 超调量 | **增大** |
| ❌ 调节时间 | **增加** |
| ❌ 振荡 | **加剧** |
| ⚠️ 积分饱和 | Ki过大易饱和 |

#### 积分饱和（Integral Windup）

**问题**：当控制输出达到饱和限制时，积分项继续累积，导致：
- 超调量增大
- 调节时间延长
- 系统响应迟钝

**示例**：
```python
# 控制输出限制在[-100, 100]
if control_output > 100:
    control_output = 100  # 饱和
    # 但积分项仍在累积！
```

**解决方法**：
1. **条件积分**：输出饱和时停止积分
2. **积分限幅**：限制积分项的最大值
3. **反向计算（Back-calculation）**：根据饱和量调整积分项

**本项目实现**（见 `pid_controller.py`）：
```python
# 简单的输出限幅
output = np.clip(output, self.output_limits[0], self.output_limits[1])
```

#### I控制的必要性

**为什么需要积分项？**

1. **消除静差**：很多系统存在内在偏移（如重力、摩擦）
2. **补偿未建模动态**：模型误差导致的系统性偏差
3. **抗恒定干扰**：如风、坡度等恒定扰动

**实际例子**：
- 无人机悬停：需要I项补偿重力
- 温度控制：需要I项补偿散热
- 液位控制：需要I项补偿出流

### 3.2.3 微分控制（D - Derivative）

#### 数学表达

$$u_d(t) = K_d \frac{de(t)}{dt}$$

**物理意义**：
- 控制作用正比于误差的**变化率**
- $K_d$：微分增益，阻尼系数

#### 作用机制

**类比**：汽车刹车系统→提前预判，防止冲过头

- **误差快速增大** → 强制动作用（提前制动）
- **误差快速减小** → 减弱控制（防止过冲）
- **误差恒定** → 无作用

#### 微分作用示意

```
  e(t)
   ↑
   │   ╱╲
   │  ╱  ╲      ← 误差变化
   │ ╱    ╲
   └──────────── t
   
  de/dt
   ↑
   │  ╱──╲
   │ ╱    ╲──   ← 微分项：在峰值前产生反向作用
   │╱        ╲
   └──────────── t
       提前制动
```

#### Kd对系统的影响

| Kd增大 | 效果 |
|--------|------|
| ✅ 超调量 | **减小** |
| ✅ 调节时间 | **减小** |
| ✅ 阻尼 | **增强** |
| ✅ 稳定性 | **提高** |
| ❌ 噪声敏感度 | **增大** |
| ❌ 高频振荡 | 可能引起高频抖动 |

#### 微分项的实际问题

**1. 噪声放大**

测量噪声的高频成分会被微分放大：

$$u_d = K_d \frac{d(e + noise)}{dt} \approx K_d \frac{d(noise)}{dt}$$

噪声的导数非常大！

**示例**：
```
测量值:  1.00, 1.01, 0.99, 1.00, 1.02 (±0.02噪声)
导数:        1,    -2,    1,    2     (放大100倍!)
```

**解决方法**：

1. **低通滤波**：
   $$u_d = \frac{K_d s}{\tau_f s + 1} E(s)$$
   其中 $\tau_f$ 是滤波时间常数

2. **测量值微分而非误差微分**：
   $$u_d = -K_d \frac{dy(t)}{dt}$$
   设定值通常不变，只对测量值微分

3. **离散微分平滑**：
   $$\frac{de}{dt} \approx \frac{e_k - e_{k-n}}{n\Delta t}$$
   使用多步差分

**2. 微分饱和**

设定值阶跃时，误差突变导致微分项理论上无穷大。

**解决方法**：
- 对测量值微分而非误差
- 设定值斜坡变化而非阶跃

#### D控制的工程实践

**何时使用微分项？**

✅ **适合使用**：
- 二阶以上系统
- 有明显惯性的系统（机械、热系统）
- 超调量要求严格的场合

❌ **不适合使用**：
- 测量噪声大的场合
- 快速采样系统（噪声影响大）
- 一阶系统（作用有限）

**工程经验**：
- Kd通常比Kp小一个数量级
- 工业中30%的PID控制器不使用D项（PI控制）
- 温度控制、液位控制常用PI而非PID

### 3.2.4 PID三项的协同作用

**时间尺度分类**：

```
      作用时间尺度
         │
   过去  │  现在  │  未来
─────────┼────────┼─────────→
         │        │
    积分项 │ 比例项 │ 微分项
   (累积) │ (当前) │ (预判)
         │        │
```

**协同关系**：

1. **P + I组合（PI控制）**
   - P：快速响应当前误差
   - I：消除稳态误差
   - **最常用组合**，占工业应用80%

2. **P + D组合（PD控制）**
   - P：基本控制作用
   - D：阻尼，减小超调
   - 适合无静差要求的场合

3. **P + I + D组合（PID控制）**
   - 综合性能最佳
   - 调参难度大
   - 适合复杂系统

**频域特性**：

| 频率范围 | 主导项 | 作用 |
|---------|--------|------|
| **低频（稳态）** | I | 消除静差 |
| **中频（过渡）** | P | 主要控制作用 |
| **高频（快变）** | D | 阻尼与抑制 |

---

## 3.3 PID参数整定方法

### 3.3.1 参数整定的目标

**性能指标权衡**：

```
         快速性
            ↑
            │     理想区
            │   ╱────╲
            │ ╱        ╲
            │╱          ╲
  ──────────┼────────────╲─→ 稳定性
            │              ╲
         不稳定             过慢
```

**设计目标**：
- ⏱️ 上升时间短（快速响应）
- 📊 超调量小（平稳）
- 🎯 调节时间短（快速稳定）
- ✅ 稳态误差小或为零（精确）
- 💪 鲁棒性强（抗干扰）

### 3.3.2 手动整定法（Trial and Error）

**步骤**：

#### 第1步：确定控制方向和初值

```python
Kp = 1.0
Ki = 0.0
Kd = 0.0
```

测试：
- 误差为正时，控制输出应该使误差减小
- 如果方向相反，Kp改为负值

#### 第2步：仅调节Kp

固定 Ki=0, Kd=0，逐步增大Kp：

| Kp | 现象 | 操作 |
|----|------|------|
| 太小 | 响应慢，误差大 | ↑ 增大 |
| 合适 | 响应较快，有小振荡 | ✓ 记录 |
| 太大 | 持续振荡或发散 | ↓ 减小 |

**目标**：找到临界Kp（刚开始振荡的值），取其50-70%

#### 第3步：加入Ki

固定Kp，从小值开始加入Ki（如Kp/10）：

| Ki | 现象 | 操作 |
|----|------|------|
| 太小 | 稳态误差消除慢 | ↑ 增大 |
| 合适 | 稳态误差快速消除，超调可接受 | ✓ 记录 |
| 太大 | 超调大，振荡加剧 | ↓ 减小 |

#### 第4步：加入Kd（可选）

固定Kp和Ki，从小值开始加入Kd（如Kp/10）：

| Kd | 现象 | 操作 |
|----|------|------|
| 0 | 有超调 | ↑ 增大 |
| 合适 | 超调明显减小 | ✓ 记录 |
| 太大 | 控制输出抖动，对噪声敏感 | ↓ 减小 |

#### 第5步：综合微调

反复调整三个参数，观察：
- 阶跃响应曲线
- 抗干扰能力
- 设定值跟踪性能

### 3.3.3 Ziegler-Nichols整定法

**Z-N方法**是最著名的PID整定方法，由Ziegler和Nichols于1942年提出。

#### 方法一：临界比例法（闭环法）

**步骤**：

1. **设置**：Ki = 0, Kd = 0（纯P控制）

2. **增大Kp**：从小到大调节Kp，直至系统出现**等幅振荡**

3. **记录临界参数**：
   - $K_u$：临界比例增益（Ultimate Gain）
   - $T_u$：振荡周期（Ultimate Period）

4. **计算PID参数**：

| 控制器类型 | $K_p$ | $K_i$ | $K_d$ |
|-----------|-------|-------|-------|
| **P** | $0.5 K_u$ | 0 | 0 |
| **PI** | $0.45 K_u$ | $0.54 K_u / T_u$ | 0 |
| **PID** | $0.6 K_u$ | $1.2 K_u / T_u$ | $0.075 K_u T_u$ |

**示例**：

测试得到 $K_u = 10$，$T_u = 2$s

PID参数：
- $K_p = 0.6 \times 10 = 6$
- $K_i = \frac{1.2 \times 10}{2} = 6$
- $K_d = 0.075 \times 10 \times 2 = 1.5$

**优点**：
- ✅ 原理简单，易于理解
- ✅ 基于实际系统响应

**缺点**：
- ❌ 需要系统进入临界振荡（可能危险）
- ❌ 不适合不稳定系统
- ❌ 参数偏激进，可能需要微调

#### 方法二：阶跃响应法（开环法）

**适用于**：一阶+时滞系统近似

**步骤**：

1. **开环阶跃测试**：
   - 断开反馈回路
   - 施加阶跃输入
   - 记录输出响应

2. **绘制响应曲线**：

```
    y(t)
     │
     │        ╱────── K (稳态增益)
     │      ╱
     │    ╱·         ← 拐点
   L │  ╱╱
     │╱╱
     └┴────────────── t
      L (延迟时间)
      │←─ T ─→│ (时间常数)
```

3. **确定参数**：
   - **L**：延迟时间（Dead Time）
   - **T**：时间常数（Time Constant）
   - **K**：稳态增益

   可通过**切线法**：在拐点做切线

4. **计算PID参数**：

| 控制器 | $K_p$ | $K_i$ | $K_d$ |
|-------|-------|-------|-------|
| **P** | $\frac{T}{KL}$ | 0 | 0 |
| **PI** | $0.9\frac{T}{KL}$ | $\frac{0.27K_p}{L}$ | 0 |
| **PID** | $1.2\frac{T}{KL}$ | $\frac{0.6K_p}{L}$ | $0.6K_p L$ |

**优点**：
- ✅ 无需闭环测试，较安全
- ✅ 适用于不稳定系统

**缺点**：
- ❌ 仅适合一阶+时滞模型
- ❌ 需要开环测试（某些系统困难）

### 3.3.4 Cohen-Coon整定法

**改进的开环法**，对大时滞系统效果更好。

**参数定义**：

$$R = \frac{L}{T}$$

R越大，时滞越显著。

**PID参数**：

$$K_p = \frac{T}{KL}\left(1 + \frac{R}{12}\right)$$

$$K_i = K_p \frac{30 + 3R}{9 + 20R}L$$

$$K_d = K_p \frac{4}{11 + 2R}L$$

### 3.3.5 Lambda整定法（IMC方法）

**基本思想**：指定闭环时间常数 $\lambda$（调节速度）

**特点**：
- 参数选择直观（$\lambda$ 越小，响应越快）
- 鲁棒性好
- 适合一阶系统

**对于一阶+时滞系统**：

$$G(s) = \frac{K e^{-Ls}}{Ts + 1}$$

PID参数：

$$K_p = \frac{T}{K(\lambda + L)}$$

$$K_i = \frac{K_p}{T}$$

$$K_d = 0$$

（通常使用PI控制）

**$\lambda$ 选择**：
- 快速响应：$\lambda = L$
- 鲁棒设计：$\lambda = 3L \sim 10L$

### 3.3.6 参数整定方法对比

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **手动整定** | 灵活，可根据实际调整 | 耗时，依赖经验 | 所有系统 |
| **Z-N临界法** | 简单，基于实际 | 需要临界振荡，参数激进 | 稳定系统 |
| **Z-N阶跃法** | 安全，无需闭环 | 仅适合一阶+时滞 | 简单过程 |
| **Cohen-Coon** | 对大时滞好 | 计算复杂 | 时滞系统 |
| **Lambda/IMC** | 鲁棒，参数直观 | 主要用于PI | 一阶系统 |

---

## 3.4 常见工程控制案例

### 3.4.1 温度控制系统

**系统特性**：
- 一阶系统，时间常数大（几分钟到几小时）
- 有较大延迟
- 通常无需微分项

**典型参数**（房间温度，τ=15分钟）：

```python
Kp = 2.0   # 温和响应
Ki = 0.1   # 慢速积分
Kd = 0.0   # 通常不用
```

**调节要点**：
- ✅ 使用PI控制
- ✅ Ki不宜过大（防止超调浪费能源）
- ✅ 可加前馈（环境温度补偿）

**实际应用**：
- 空调系统
- 烤箱、恒温箱
- 化工反应釜

**在本项目中的实现**：
```bash
python start.py mpc-temp
```
文件：`MPCController/mpc_temperature_control.py`

### 3.4.2 液位控制系统

**系统特性**：
- 一阶积分系统（液位是流量的积分）
- 响应较慢
- 易受入流扰动影响

**典型参数**（水箱，截面积1m²）：

```python
Kp = 0.5   # 比例作用
Ki = 0.2   # 消除液位偏差
Kd = 0.1   # 小阻尼
```

**调节要点**：
- ✅ PI控制为主
- ✅ 注意积分饱和（液位有上下限）
- ✅ 可使用串级控制（液位外环+流量内环）

**实际应用**：
- 水箱液位
- 油罐液位
- 汽包水位

### 3.4.3 压力控制系统

**系统特性**：
- 响应快（气体可压缩性）
- 可能有振荡
- 噪声较大

**典型参数**（气罐压力）：

```python
Kp = 1.5
Ki = 0.8   # 消除稳态偏差
Kd = 0.3   # 抑制压力波动
```

**调节要点**：
- ✅ PID全用
- ✅ 注意测量滤波（压力传感器噪声）
- ✅ 防止频繁动作（阀门寿命）

### 3.4.4 速度控制系统（电机）

**系统特性**：
- 一阶或二阶系统
- 响应快
- 负载变化是主要干扰

**典型参数**（直流电机转速）：

```python
Kp = 3.0   # 快速响应
Ki = 1.5   # 抗负载干扰
Kd = 0.5   # 减小超调
```

**调节要点**：
- ✅ PI或PID控制
- ✅ I项对抗负载变化很重要
- ✅ 注意电流限制（饱和）

**实际应用**：
- 直流电机调速
- 交流变频调速
- 伺服电机

### 3.4.5 位置控制系统（伺服）

**系统特性**：
- 二阶系统
- 要求高精度、快速响应
- 常有机械谐振

**典型参数**（伺服定位）：

```python
Kp = 10.0  # 高增益，快速响应
Ki = 2.0   # 消除静差
Kd = 1.5   # 大阻尼，减小超调
```

**调节要点**：
- ✅ PID全用，参数值较大
- ✅ D项很重要（阻尼机械振动）
- ✅ 可能需要前馈（轨迹跟踪）
- ✅ 注意机械共振频率

**实际应用**：
- 数控机床
- 机器人关节
- 天线指向

### 3.4.6 案例对比总结

| 对象 | 时间常数 | 推荐控制 | Kp | Ki | Kd | 特点 |
|------|---------|---------|----|----|----|----|
| **温度** | 大（分-小时） | PI | 中 | 小 | 无 | 慢过程，无需D |
| **液位** | 大（分钟） | PI | 小 | 小 | 小 | 积分系统 |
| **压力** | 中（秒） | PID | 中 | 中 | 小 | 有噪声 |
| **速度** | 小（秒内） | PI/PID | 大 | 中 | 中 | 快过程 |
| **位置** | 小（秒内） | PID | 大 | 中 | 大 | 高精度要求 |

---

## 3.5 PID控制器的实际实现

### 3.5.1 离散PID算法

**位置式PID**（Position Form）：

$$u_k = K_p e_k + K_i \sum_{j=0}^k e_j \Delta t + K_d \frac{e_k - e_{k-1}}{\Delta t}$$

**特点**：
- 输出是绝对值
- 需要累加所有历史误差
- 适合控制量是绝对位置的系统

**增量式PID**（Velocity Form）：

$$\Delta u_k = u_k - u_{k-1} = K_p(e_k - e_{k-1}) + K_i e_k \Delta t + K_d(e_k - 2e_{k-1} + e_{k-2})$$

$$u_k = u_{k-1} + \Delta u_k$$

**特点**：
- 输出是增量
- 只需存储3个误差值
- 误差小，适合增量控制（如阀门开度调整）

**本项目采用位置式**，代码见 `PIDController/pid_controller.py`：

```python
def update(self, measured_value, dt):
    # 计算误差
    error = self.setpoint - measured_value
    
    # 比例项
    p_term = self.Kp * error
    
    # 积分项
    self.integral += error * dt
    i_term = self.Ki * self.integral
    
    # 微分项
    if dt > 0:
        derivative = (error - self.previous_error) / dt
    else:
        derivative = 0.0
    d_term = self.Kd * derivative
    
    # 总输出
    output = p_term + i_term + d_term
    
    # 输出限幅
    output = np.clip(output, self.output_limits[0], self.output_limits[1])
    
    # 更新状态
    self.previous_error = error
    
    return output
```

### 3.5.2 采样时间的影响

**采样定理**：

采样频率应至少为系统带宽的10倍：

$$f_s \geq 10 \times f_{bandwidth}$$

或：

$$\Delta t \leq \frac{T_{settling}}{100}$$

**示例**：
- 温度控制（调节时间10分钟）→ $\Delta t \leq 6$s
- 电机速度控制（调节时间1秒）→ $\Delta t \leq 10$ms
- 伺服位置控制（调节时间0.1秒）→ $\Delta t \leq 1$ms

**注意事项**：
- ⚠️ 采样时间过长 → 控制性能下降，可能不稳定
- ⚠️ 采样时间过短 → 计算负担重，数值误差增大
- ⚠️ 微分项对采样时间敏感（噪声放大）

### 3.5.3 抗积分饱和

**问题描述**：

```python
# 控制输出限制
u_max = 100
u_min = -100

# 但积分项不断累积
integral += error * dt  # 可能达到10000!

# 导致后续响应迟钝
```

**解决方案1：条件积分**

```python
if u_min < output < u_max:
    # 仅在未饱和时积分
    integral += error * dt
```

**解决方案2：积分分离**

```python
if abs(error) > threshold:
    # 误差大时不积分
    i_term = 0
else:
    # 误差小时才积分
    integral += error * dt
    i_term = Ki * integral
```

**解决方案3：积分限幅**

```python
integral = np.clip(integral, -integral_max, integral_max)
```

**解决方案4：Back-calculation（反向计算）**

```python
# 计算理想输出
output_ideal = p_term + i_term + d_term

# 限幅
output_actual = np.clip(output_ideal, u_min, u_max)

# 根据差值调整积分项
if output_actual != output_ideal:
    integral -= (output_ideal - output_actual) / Ki
```

### 3.5.4 微分项的实用改进

**问题1：噪声敏感**

**改进**：一阶低通滤波

$$D(s) = \frac{K_d s}{\tau_f s + 1}$$

离散形式：

```python
# 一阶滤波
alpha = dt / (tau_f + dt)
filtered_derivative = alpha * derivative + (1 - alpha) * filtered_derivative_old
d_term = Kd * filtered_derivative
```

**问题2：设定值阶跃**

设定值突变时 $\frac{de}{dt}$ 理论无穷大。

**改进**：对测量值微分而非误差

```python
# 原始：对误差微分
d_term = Kd * (error - error_old) / dt

# 改进：对测量值微分（设定值通常不变）
d_term = -Kd * (measured_value - measured_value_old) / dt
```

### 3.5.5 参数自整定

**在线自整定方法**：

1. **继电反馈法（Relay Feedback）**
   - 自动找临界振荡参数
   - 应用Z-N法则

2. **模式识别法**
   - 识别响应曲线特征
   - 自动计算参数

3. **自适应PID**
   - 在线辨识系统参数
   - 实时调整PID参数

**简单自适应策略**：

```python
# 根据误差大小调整Kp
if abs(error) > large_threshold:
    Kp_actual = Kp * 0.7  # 减小Kp防止振荡
elif abs(error) < small_threshold:
    Kp_actual = Kp * 1.3  # 增大Kp加快收敛
else:
    Kp_actual = Kp
```

---

## 3.6 本项目中的PID实验

### 3.6.1 实验概述

本项目提供了4个详细的PID实验，代码位于 `PIDController/pid_experiments.py`。

#### 实验1：Kp参数影响

**测试配置**：
- 系统：一阶系统（τ=1.0）
- Kp：0.5, 1.0, 2.0, 5.0, 10.0
- Ki = 0, Kd = 0

**观察指标**：
- 上升时间
- 稳态误差
- 控制信号大小

**运行**：
```bash
cd PIDController
python pid_experiments.py
```

**结论**：
- Kp↑ → 响应更快，误差更小
- Kp过大 → 可能振荡
- 纯P控制有稳态误差

#### 实验2：Ki参数影响

**测试配置**：
- 系统：一阶系统+小噪声
- Kp = 2.0（固定）
- Ki：0.0, 0.5, 1.0, 2.0, 5.0
- Kd = 0

**观察指标**：
- 稳态误差
- 积分项累积
- 超调量

**结论**：
- Ki能消除稳态误差
- Ki↑ → 误差消除更快，但超调增大
- 积分项持续累积直至误差为0

#### 实验3：Kd参数影响

**测试配置**：
- 系统：二阶系统（质量-阻尼-弹簧）
- Kp = 5.0, Ki = 1.0（固定）
- Kd：0.0, 0.5, 1.0, 2.0, 5.0

**观察指标**：
- 超调量
- 微分项贡献
- 噪声敏感度

**结论**：
- Kd显著减小超调
- Kd↑ → 阻尼增强
- Kd对测量噪声敏感

#### 实验4：PID综合调节

**对比5种配置**：
1. 仅P控制（Kp=3.0）
2. PI控制（Kp=3.0, Ki=1.5）
3. PD控制（Kp=3.0, Kd=1.0）
4. 未调优PID（Kp=5.0, Ki=5.0, Kd=0.1）
5. 优化PID（Kp=3.5, Ki=1.8, Kd=1.2）

**测试场景**：
- 初始阶跃响应
- t=10s时施加扰动

**结论**：
- P：快但有误差
- PI：消除误差但超调
- PD：减小超调但仍有误差
- 优化PID：综合性能最佳

### 3.6.2 运行实验

**方式1：通过start.py运行**
```bash
python start.py demo
```

**方式2：直接运行实验脚本**
```bash
cd PIDController
python pid_experiments.py
```

**方式3：快速演示**
```bash
python start.py quick
```

### 3.6.3 查看结果

所有实验图表保存在 `output/` 目录：

- `experiment_1_kp_effect.png` - Kp影响
- `experiment_2_ki_effect.png` - Ki影响
- `experiment_3_kd_effect.png` - Kd影响
- `experiment_4_combined_tuning.png` - 综合对比
- `quick_demo.png` - 快速演示

---

## 3.7 本章小结

### 核心知识点回顾

#### PID数学表达

$$u(t) = K_p e(t) + K_i \int_0^t e(\tau) d\tau + K_d \frac{de(t)}{dt}$$

#### 三要素作用

| 项 | 作用 | 增大效果 | 局限 |
|----|------|---------|------|
| **P** | 基本控制，正比于误差 | 响应快，误差小 | 有静差 |
| **I** | 消除静差，累积误差 | 消除稳态误差 | 超调增大，饱和 |
| **D** | 阻尼，预判趋势 | 减小超调 | 噪声敏感 |

#### 参数整定方法

| 方法 | 特点 | 适用 |
|------|------|------|
| **手动整定** | 灵活 | 所有系统 |
| **Z-N临界法** | 简单但激进 | 稳定系统 |
| **Z-N阶跃法** | 安全 | 一阶+时滞 |
| **Lambda/IMC** | 鲁棒 | 一阶系统 |

#### 工程经验法则

1. **开始整定**：
   - Kp = 1.0, Ki = 0, Kd = 0
   - 逐步增大Kp

2. **控制器选择**：
   - 温度、液位 → PI
   - 压力、速度 → PI或PID
   - 位置、伺服 → PID

3. **参数关系**（经验值）：
   - Ki ≈ Kp/5
   - Kd ≈ Kp/10

4. **采样时间**：
   - Δt ≤ 调节时间/100

### 本项目中的实践

| 理论内容 | 项目实现 | 文件 |
|---------|---------|------|
| **PID算法** | 完整实现 | `PIDController/pid_controller.py` |
| **Kp影响** | 实验1 | `pid_experiments.py` → `experiment_1_kp_effect.png` |
| **Ki影响** | 实验2 | `pid_experiments.py` → `experiment_2_ki_effect.png` |
| **Kd影响** | 实验3 | `pid_experiments.py` → `experiment_3_kd_effect.png` |
| **综合调节** | 实验4 | `pid_experiments.py` → `experiment_4_combined_tuning.png` |
| **系统建模** | 一阶/二阶系统 | `PIDController/simulated_system.py` |
| **CartPole案例** | 倒立摆PID | `PIDController/cartpole_pid.py` |

### 学习建议

1. **理论学习**
   - 理解PID三项的物理意义
   - 掌握整定方法的原理
   - 了解工程应用场景

2. **动手实验**
   ```bash
   # 运行所有PID实验
   python start.py demo
   
   # 修改参数，观察效果
   # 编辑 pid_experiments.py 中的参数值
   ```

3. **参数调优练习**
   - 尝试为不同系统整定参数
   - 对比不同整定方法的效果
   - 观察扰动下的控制性能

4. **深入思考**
   - 为什么PI是最常用的组合？
   - 什么时候必须用D项？
   - 如何平衡快速性和稳定性？

---

## 3.8 实战练习

### 练习1：手动整定温度控制器

**题目**：
一阶温度系统：$G(s) = \frac{0.5}{10s+1}$

要求：
1. 使用手动整定法找到合适的PI参数
2. 调节时间 < 30秒
3. 无稳态误差
4. 超调量 < 10%

**提示**：
- 先用纯P控制测试临界Kp
- 然后加入Ki消除误差

### 练习2：Z-N方法整定

**题目**：
某系统通过临界测试得到：
- 临界增益 $K_u = 8$
- 振荡周期 $T_u = 4$s

要求：
1. 使用Z-N方法计算PID参数
2. 计算PI参数（对比）
3. 说明哪种更合适

**参考**：

PID参数：
- $K_p = 0.6 \times 8 = 4.8$
- $K_i = \frac{1.2 \times 8}{4} = 2.4$
- $K_d = 0.075 \times 8 \times 4 = 2.4$

PI参数（更保守）：
- $K_p = 0.45 \times 8 = 3.6$
- $K_i = \frac{0.54 \times 8}{4} = 1.08$

### 练习3：性能分析

**题目**：
观察本项目实验4的结果图，回答：

1. 为什么仅P控制有稳态误差？
2. PI控制的超调为什么比P大？
3. 扰动发生后，哪种控制器恢复最快？为什么？

**分析要点**：
- P项：快速但不完整
- I项：完整但可能过头
- D项：阻尼但不消除误差

---

## 📚 扩展阅读

### 推荐教材

1. **《PID控制器参数整定设计》** - 李国勇
2. **《先进PID控制MATLAB仿真》** - 刘金琨
3. **《自动控制原理》第8-9章** - 胡寿松
4. **"PID Controllers: Theory, Design, and Tuning"** - Åström & Hägglund

### 在线资源

1. **Brian Douglas - PID Control**
   - YouTube系列视频
   - 清晰易懂的原理讲解

2. **Control Tutorials for MATLAB**
   - PID设计实例
   - 交互式仿真

3. **工业PID整定手册**
   - 各厂商应用指南
   - 实际案例分析

### 进阶主题

1. **自适应PID**
   - 参数自整定
   - 增益调度

2. **模糊PID**
   - 模糊规则
   - 参数在线调整

3. **串级PID**
   - 主副回路设计
   - 参数配合

4. **前馈+PID**
   - 前馈补偿
   - 复合控制

### 下一步学习

- [第4章：现代控制理论基础](第4章_现代控制理论基础.md)
- [第5章：先进控制方法（MPC）](../doc/MPC控制器说明.md)
- [与强化学习的对比](../doc/PID_vs_RL_对比.md)

---

## 附录：PID参数速查表

### 标准整定公式汇总

#### Ziegler-Nichols临界法

| 控制器 | $K_p$ | $T_i$ | $T_d$ |
|-------|-------|-------|-------|
| P | $0.5K_u$ | - | - |
| PI | $0.45K_u$ | $T_u/1.2$ | - |
| PID | $0.6K_u$ | $T_u/2$ | $T_u/8$ |

#### Ziegler-Nichols阶跃法

| 控制器 | $K_p$ | $T_i$ | $T_d$ |
|-------|-------|-------|-------|
| P | $T/(KL)$ | - | - |
| PI | $0.9T/(KL)$ | $3.3L$ | - |
| PID | $1.2T/(KL)$ | $2L$ | $0.5L$ |

### 常见系统典型参数

| 系统 | Kp | Ki | Kd | 备注 |
|------|----|----|----|----|
| 温度（小） | 2-5 | 0.1-0.5 | 0 | PI控制 |
| 温度（大） | 1-3 | 0.01-0.1 | 0 | 惯性大 |
| 液位 | 0.5-2 | 0.1-0.5 | 0-0.2 | PI为主 |
| 压力 | 1-3 | 0.5-1.5 | 0.2-0.8 | PID |
| 速度 | 3-10 | 1-5 | 0.3-1.5 | PI或PID |
| 位置 | 10-50 | 2-10 | 1-5 | PID，高增益 |

---

> **导航**: [返回课程大纲](../CONTROL_ENGINEERING_OUTLINE.md) | [上一章：系统动力学与响应](第2章_系统动力学与响应.md) | [下一章：现代控制理论](第4章_现代控制理论基础.md)

---

**最后更新**: 2025年10月30日  
**作者**: Control Engineering Lab

